<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<title>Bitcoin Collectors Edition — Presale</title>

<style>
:root{
  --bg-dark:#120b06;
  --bg-mid:#1a1009;
  --gold:#d4af37;
  --gold-soft:#bfa24a;
  --text:#e6e1d8;

  --hero-max-width: 1200px;
  --section-gap: clamp(56px, 8vw, 140px);
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
  font-family: Arial, Helvetica, sans-serif;
  color:var(--text);
  text-align:center;
  background: radial-gradient(circle at center, var(--bg-mid), var(--bg-dark));
  background-color: var(--bg-dark);
}

.hero{ padding: 10px 10px 10px; }

header{ position: relative; z-index: 10; }

header h1{
  color: var(--gold);
  font-size: clamp(28px, 5.2vw, 120px);
  letter-spacing: 0.08em;
  white-space: nowrap;
  overflow: hidden;
  width: 100%;
  margin: 0 0 6px 0;
  font-weight: 550;
}

header h2{
  color: var(--gold);
  font-size: 20px;
  letter-spacing: 3px;
  margin: 4px 0 4px;
  font-weight: 500;
}

nav{
  margin-top:13px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap: 10px 18px;
  padding: 0 10px;
  position: relative;
  z-index: 11;
}
nav a{
  color:var(--gold-soft);
  text-decoration:none;
  font-size:14px;
  letter-spacing:2px;
  position:relative;
  transition: color 0.3s ease;
  white-space: nowrap;
}
nav a::after{
  content:"";
  position:absolute;
  left:0;
  bottom:-6px;
  width:0%;
  height:1px;
  background:var(--gold);
  transition: width 0.3s ease;
}
nav a:hover{ color:var(--gold); }
nav a:hover::after{ width:100%; }

/* Buttons */
.btn{
  background: transparent;
  border: 1px solid var(--gold);
  color: var(--gold);
  padding: 10px 32px;
  font-size: 11px;
  letter-spacing: 3px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.35s ease;
}
.btn:hover{
  background: var(--gold);
  color: #000;
  box-shadow: 0 6px 18px rgba(212,175,55,0.35);
}

/* ✅ Disabled button look */
.btn:disabled{
  opacity: 0.45;
  cursor: not-allowed;
  box-shadow: none;
}

/* Tagline */
.tagline{
  margin: 0;
  font-size: clamp(18px, 3.2vw, 30px);
  letter-spacing: clamp(2px, 0.7vw, 4px);
  color: var(--gold-soft);
  font-weight: 700;
}

/* HERO */
.hero-image-wrap{
  position: relative;
  max-width: var(--hero-max-width);
  margin: -20px auto 0;
  padding: 0 10px;
  pointer-events: none; /* prevents hero from blocking nav hover */
}
.buy-overlay, .wallet-overlay{ pointer-events:auto; }

.buy-overlay{
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 2;
}
.wallet-overlay{
  position: absolute;
  top: 12px;
  right: 12px;
  z-index: 2;
}

.tagline-overlay{
  position: absolute;
  left: 50%;
  top: 7%;
  transform: translateX(-50%);
  z-index: 2;
  width: 100%;
  pointer-events: none;
}
.tagline-overlay .tagline{
  margin: 0;
  text-align: center;
}

.hero-canvas{
  width: 100%;
  max-width: var(--hero-max-width);
  height: auto;
  display:block;
  margin: 25px auto 0;
  filter: drop-shadow(0 14px 40px rgba(0,0,0,0.45));
}

/* Content */
section{
  max-width: 900px;
  margin: var(--section-gap) auto;
  padding: 0 20px;
}
section h3{
  color:var(--gold);
  font-size: clamp(20px, 2.8vw, 28px);
  letter-spacing: 3px;
  margin-bottom: 25px;
}
section p{
  font-size: clamp(14px, 1.8vw, 16px);
  line-height: 1.7;
}

/* Artifact link */
.artifact-link{
  color: var(--gold);
  text-decoration: none;
  letter-spacing: 2px;
  font-size: 14px;
  transition: opacity 0.3s ease;
}
.artifact-link:hover{ opacity: 0.75; }

#contact{ margin-bottom: 0; }

/* Brand emblems */
section.brand-row{
  max-width: 1200px;
  margin: 10px auto 30px;
  padding: 0 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 24px;
}
.brand-emblem{
  width: 375px;
  max-width: 42vw;
  height: auto;
  display: block;
  opacity: 0.95;
  filter: drop-shadow(0 12px 32px rgba(0,0,0,0.4));
}
.brand-left{ transform: rotate(-1deg); }
.brand-right{ transform: rotate(1deg); }

/* Footer */
footer{
  padding: 18px 20px;
  font-size: 14px;
  color: var(--gold-soft);
}

/* ===== BUY MODAL (Luxury) ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  z-index:9999;
}
.modal__backdrop{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.70);
}
.modal__panel{
  position:relative;
  max-width: 720px;
  margin: 8vh auto 0;
  background: linear-gradient(180deg, rgba(26,16,9,0.98), rgba(18,11,6,0.98));
  border: 1px solid rgba(212,175,55,0.35);
  border-radius: 16px;
  padding: 18px 18px 14px;
  color: var(--text);
  box-shadow:0 24px 70px rgba(0,0,0,0.60);
  text-align:left;
}
.modal__title{
  color: var(--gold);
  font-weight: 800;
  letter-spacing: 1px;
  font-size: 16px;
  margin-bottom: 10px;
}
.modal__sub{
  color: rgba(230,225,216,0.9);
  font-size: 14px;
  line-height: 1.5;
  margin-bottom: 12px;
}
.modal__grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}
.modal__card{
  border: 1px solid rgba(212,175,55,0.22);
  border-radius: 14px;
  padding: 14px;
  background: rgba(0,0,0,0.15);
}
.modal__card h4{
  margin-bottom: 6px;
  color: var(--gold);
  letter-spacing: 1px;
  font-size: 13px;
}
.modal__card p{
  font-size: 13px;
  line-height: 1.5;
  opacity: 0.95;
  margin-bottom: 10px;
}
.modal__row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
  margin-top: 12px;
}
.modal__close{
  border-color: rgba(212,175,55,0.45);
  opacity: 0.95;
}
.field{
  width:100%;
  padding: 10px 10px;
  border-radius: 10px;
  border: 1px solid rgba(212,175,55,0.22);
  background: rgba(0,0,0,0.22);
  color: var(--text);
  outline: none;
  font-size: 13px;
  letter-spacing: 0.5px;
}
.field::placeholder{ color: rgba(230,225,216,0.55); }
.small{
  font-size: 12px;
  opacity: 0.9;
}
.kv{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  justify-content: space-between;
  margin: 10px 0;
}
.kv code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size: 12px;
  padding: 6px 8px;
  border-radius: 10px;
  background: rgba(0,0,0,0.25);
  border: 1px solid rgba(212,175,55,0.18);
  word-break: break-all;
}

/* Toast */
#toast{
  position: fixed;
  left: 50%;
  bottom: 22px;
  transform: translateX(-50%);
  padding: 10px 12px;
  border-radius: 12px;
  background: rgba(0,0,0,0.72);
  border: 1px solid rgba(212,175,55,0.25);
  color: var(--text);
  font-size: 13px;
  letter-spacing: 0.5px;
  display:none;
  z-index:10000;
}

/* Responsive */
@media (max-width: 1024px){
  :root{ --hero-max-width: 920px; }
}

@media (max-width: 768px){
  header h1{
    white-space: normal;
    line-height: 1.15;
    letter-spacing: 0.05em;
    padding: 0 8px;
    font-size: clamp(22px, 7vw, 34px);
  }
  header h2{ font-size: 16px; letter-spacing: 2px; }
  nav a{ font-size: 13px; letter-spacing: 1.5px; }

  .buy-overlay{ top: 10px; left: 10px; }
  .wallet-overlay{ top: 10px; right: 10px; }
  .btn{ padding: 9px 18px; font-size: 10px; letter-spacing: 2px; }

  .tagline-overlay{
    top: 44px;
    padding: 0 12px;
  }
  .tagline{
    white-space: nowrap;
    font-size: clamp(14px, 4vw, 20px);
    letter-spacing: clamp(1px, 1vw, 2px);
    line-height: 1.1;
  }
  .hero-canvas{ margin-top: 70px; }

  section.brand-row{
    flex-direction: column;
    justify-content: center;
    margin: 14px auto 18px;
  }
  .brand-emblem{
    width: 260px;
    max-width: 75vw;
  }
  .brand-left, .brand-right{ transform: none; }

  .modal__panel{
    margin: 6vh 10px 0;
  }
  .modal__grid{
    grid-template-columns: 1fr;
  }
}
</style>
</head>

<body>

<div class="hero">
  <header>
    <h1>BITCOIN COLLECTORS EDITION</h1>
    <h2>PRESALE</h2>

    <nav>
      <a href="#about">ABOUT US</a>
      <a href="#roadmap">ROADMAP</a>
      <a href="#artifact">COLLECTORS GRADE ARTIFACT</a>
      <a href="#how">HOW TO BUY</a>
      <a href="https://x.com/23_exxo_23" target="_blank" rel="noopener">X</a>
      <a href="#contact">CONTACT</a>
    </nav>
  </header>

  <div class="hero-image-wrap">
    <div class="buy-overlay">
      <button class="btn" id="buyBtn" type="button">BUY</button>
    </div>

    <div class="wallet-overlay">
      <button class="btn" id="connectBtn" type="button">CONNECT WALLET</button>
    </div>

    <div class="tagline-overlay">
      <div class="tagline">THE HOLY GRAIL OF CRYPTO</div>
    </div>

    <img class="hero-canvas" src="BestCoinFace.png" alt="Bitcoin Collectors Edition">
  </div>
</div>

<section id="about">
  <h3>ABOUT US</h3>
  <p>
    BITCOIN COLLECTORS EDITION is a limited edition. 500,000 will ever exist. Supply is permanently closed,
    no minting, no future versions. This Collectors Grade Artifact was created on April 24, 2024 on the fourth day
    of the halving, representing permanence, scarcity, and historical significance within the Bitcoin ecosystem.
    This is an Elite Access Distribution through private sale, invitation, earned participation.<br>
    Ownership is a symbolic investment.
  </p>
</section>

<section id="roadmap">
  <h3>ROADMAP</h3>
  <p>
    Presale begins with 1,000 units at 0.00375 BTC each.
    For every 1,000 sold the price increases by 0.00375 BTC.
    Example: 0 - 1000 Price = .00375 BTC. 1001 - 2000 Price = .0075 BTC. 2001 - 3000
    Price = .01125 BTC. 3001 - 4000 Price = .015 BTC. 4001 - 5000 Price = .01875 BTC.
    This will continue on in this fashion until the price per token is 1.5 BTC.
    At that point the floor valuation of BITCOIN COLLECTORS EDITION is set at 1.5 BTC
    and will never be valued less than. The historic value of this Collectors Grade Artifact
    will only increase over the years because of it's historical significance and limited supply.<br>
    Ownership is Elite.
  </p>
</section>

<section id="artifact">
  <h3>COLLECTORS GRADE ARTIFACT</h3>
  <p>
    BITCOIN COLLECTORS EDITION<br>
    <br>
    Valuation = 750,000 BTC<br>
    Classification: Collectors Grade Artifact<br>
    Supply: 500,000 Fixed<br>
    Issuance: Manual &amp; Verifiable<br>
    Custody: Owner-Held Ordinals<br>
    Creation Timestamp: 2024-04-24 20:40:16 UTC<br>
    Number: 10355<br>
    ID: 840710:955<br>
    Etching Block: 840710<br>
    Etching Transaction: 955<br>
    Mintable: no<br>
    Supply: 500,000<br>
    Premined: 500,000<br>
    Premine Percentage: 100%<br>
    Burned: 0<br>
    Divisibility: 0<br>
    Etching:<br>
    54fa5ad4ebbd12940cb3e517fcefdd3e<br>
    9f5d2792941e69c9acbd277f499ccbe4<br><br>
    <a href="https://ordinals.com/rune/BITCOIN%E2%80%A2COLLECTORS%E2%80%A2EDITION"
       target="_blank" rel="noopener" class="artifact-link">View on Ordinals</a>
  </p>
</section>

<section id="how">
  <h3>HOW TO BUY</h3>
  <p>
    1. Dowload Unisat wallet browser extension.<br>
    2. Connect your UniSat wallet (UniSat only)<br>
    3. Select quantity<br>
    4. Enter your Ordinals address (Runes capable)<br>
    5. Confirm transaction<br>
    6. Batch deliveries within 24 hours<br>
    7. Welcome to the Movement!<br>
    <br>
    <strong>Desktop Recommended</strong><br>
    The Unisat wallet flow works best from desktop.<br>
    As of now:<br>
    ❌ UniSat does not publicly document any deep-link URL scheme<br>
    ❌ UniSat does not guarantee injection outside of its own in-app browser<br>
    ❌ Mobile Safari / Chrome cannot receive wallet injection from extensions<br>
        So there is no safe, standards-compliant way to:<br>
        force-open UniSat<br>
        inject itself<br>
        and auto-connect<br>
          <br>
    <strong>Note</strong><br>
    During presale deliveries will be manually sent.<br>
    After the presale is over multiple wallet options will be available and deliveries will be automated.
  </p>
</section>

<section id="company">
  <h3>COMPANY</h3>
  <p>
     <strong>ALIEN INTEGRATION MOVEMENT CORP</strong><br>
    <br>
    If we woke up tomorrow morning and on the news we were told of the existence of
    500 million extraterrestrials that have been living on this planet with us all along,
    what's the plan?
    That is the core of Alien Integration Movement Corp. The integration of extraterrestrials
    into our society as one of us. The planning and the formula is 20 years in the making.
    Our species at some point in our future will co-exist with extraterrestrials. Not only is it inevitable,
    it will be necessary to the success of our species to have multiple interspecies alliances on multiple planets.
    BITCOIN COLLECTORS EDITION was created to play a major part in the financial infrastructure of the Movement and
    the development of the necessary infrastructure for the Alien Integration Movement and the Extraterrestrial Citizenship Program.
    You would be participating in the most historical event that has ever occurred on our planet.<br>
    Owning BITCOIN COLLECTORS EDITION will be a monumental ownership.
  </p>
</section>

<section id="contact">
  <h3>CONTACT</h3>
  <p>
    For legitimate inquiries only.<br>
    admin@bitcoincollectorsedition.com
  </p>
</section>

<section class="brand-row" aria-label="Brand emblems">
  <img class="brand-emblem brand-left" src="LoveBrand.png" alt="LOVE Emblem">
  <img class="brand-emblem brand-right" src="LoveBrand.png" alt="LOVE Emblem">
</section>

<footer>
  © Bitcoin Collectors Edition<br>
  © Alien Integration Movement Corp
</footer>

<!-- ===== BUY / CHECKOUT MODAL ===== -->
<div class="modal" id="buyModal" aria-hidden="true">
  <div class="modal__backdrop" id="buyModalBackdrop"></div>
  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="buyModalTitle">
    <div class="modal__title" id="buyModalTitle">Purchase — BITCOIN COLLECTORS EDITION</div>
    <div class="modal__sub">
      Presale price: <b>0.00375 BTC</b> per token (first 1,000). Deliveries are batched and delivered within 24 hours.
    </div>

    <div class="modal__card" style="margin-bottom:12px;">
      <h4>Order Details</h4>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <div class="small" style="margin:6px 0;">Tokens</div>
          <input class="field" id="tokensInput" inputmode="numeric" placeholder="e.g. 10" />
        </div>
        <div>
          <div class="small" style="margin:6px 0;">Total BTC</div>
          <input class="field" id="totalBtcDisplay" disabled value="—" />
        </div>
      </div>

      <div class="small" style="margin:10px 0 6px;">Ordinals address (Runes capable)</div>
      <input class="field" id="ordinalsInput" placeholder="Paste your Ordinals address" />

      <div class="small" style="margin:10px 0 6px;">(Optional) Buyer wallet address</div>
      <input class="field" id="buyerWalletInput" placeholder="Optional: your BTC address" />
    </div>

    <div class="modal__grid">
      <div class="modal__card">
        <h4>Preferred</h4>
        <p>
          Use UniSat for a seamless payment (TXID captured automatically). Works on desktop, and in UniSat environments where wallet injection is available.
        </p>
        <button class="btn" id="payWithUnisatBtn" type="button">PAY NOW (UNISAT)</button>
      </div>

      <div class="modal__card" id="mobileFallbackCard">
        <h4>Mobile Checkout</h4>
        <p>
          If UniSat isn’t detected on this browser, use the UniSat app browser or pay via BTC QR and paste the TXID to finalize your receipt.
        </p>
        <button class="btn" id="openMobileOptionsBtn" type="button">MOBILE OPTIONS</button>
      </div>
    </div>

    <div class="modal__row">
      <button class="btn modal__close" id="closeBuyModalBtn" type="button">CLOSE</button>
    </div>
  </div>
</div>

<!-- ===== MOBILE OPTIONS MODAL ===== -->
<div class="modal" id="mobileModal" aria-hidden="true">
  <div class="modal__backdrop" id="mobileModalBackdrop"></div>
  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="mobileModalTitle">
    <div class="modal__title" id="mobileModalTitle">Continue on Mobile</div>
    <div class="modal__sub">
      Mobile browsers typically can’t access the UniSat extension. Choose the best option below.
    </div>

    <div class="modal__grid">
      <div class="modal__card">
        <h4>Option 1 — UniSat App Browser</h4>
        <p>
          Open UniSat → Browser/DApp → Paste this page link. Then connect + pay inside UniSat.
        </p>
        <div class="kv">
          <span class="small">Page URL</span>
          <code id="pageUrlCode"></code>
        </div>
        <button class="btn" id="copyPageUrlBtn" type="button">COPY PAGE LINK</button>
        <a class="btn" href="https://unisat.io/download" target="_blank" rel="noopener"
           style="display:inline-block; text-decoration:none; margin-top:10px;">INSTALL / OPEN UNISAT</a>
      </div>

      <div class="modal__card">
        <h4>Option 2 — Pay with BTC (QR)</h4>
        <p>
          Send the exact amount to the address below. After sending, paste the TXID to record your receipt.
        </p>

        <div class="kv">
          <span class="small">Send To</span>
          <code id="btcAddrCode"></code>
        </div>

        <div class="kv">
          <span class="small">Amount</span>
          <code id="btcAmountCode">—</code>
        </div>

        <div style="margin:10px 0;">
          <img id="qrImg" alt="BTC QR" style="width:220px; height:220px; border-radius:14px; border:1px solid rgba(212,175,55,0.22);" />
        </div>

        <div class="small" style="margin:10px 0 6px;">Paste TXID after payment</div>
        <input class="field" id="txidInput" placeholder="Transaction ID (TXID)" />

        <button class="btn" id="submitPaidBtn" type="button" style="margin-top:10px;">I PAID — SUBMIT TXID</button>
      </div>
    </div>

    <div class="modal__row">
      <button class="btn modal__close" id="closeMobileModalBtn" type="button">CLOSE</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/** =========================
 *  CONFIG (yours)
 *  ========================= */
const PRICE_PER_TOKEN_BTC = 0.00375;
const BTC_RECEIVE_ADDRESS = "bc1pymsx9zrf7dl5h7vsupmfvnt7vp8hqcw8kxptsglvzvea6enhm2ys0h3hw2";
const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzcq31mNHjhLB576IGrrgWTXzFrt1xr3C5pzOMMtJlBs7x_rsK3f2jYXbWgG5y2RU7D/exec";

/** =========================
 *  Helpers
 *  ========================= */
function showToast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(showToast._timer);
  showToast._timer = setTimeout(()=> t.style.display="none", 3200);
}

function isMobile(){
  return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || "");
}

function hasUnisat(){
  return typeof window.unisat !== "undefined";
}

/* ✅ Connect button polish + UI-state */
function shortAddr(addr){
  if(!addr || addr.length < 10) return addr || "";
  return addr.slice(0, 6) + "..." + addr.slice(-4);
}
let connectedAccount = ""; // UI-state only
function setConnectBtnUI(){
  if(connectedAccount){
    connectBtn.textContent = `CONNECTED: ${shortAddr(connectedAccount)}`;
    connectBtn.dataset.connected = "1";
  }else{
    connectBtn.textContent = "CONNECT WALLET";
    delete connectBtn.dataset.connected;
  }
}

function openModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = "block";
  el.setAttribute("aria-hidden","false");
}
function closeModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.display = "none";
  el.setAttribute("aria-hidden","true");
}

function round8(n){
  // BTC display: up to 8 decimals
  return (Math.round(n * 1e8) / 1e8).toFixed(8);
}

function calc(){
  const tokensRaw = (tokensInput.value || "").trim();
  const tokens = Number(tokensRaw);
  if(!Number.isFinite(tokens) || tokens <= 0) return { tokens: 0, totalBTC: 0 };
  const totalBTC = tokens * PRICE_PER_TOKEN_BTC;
  return { tokens, totalBTC };
}

function setTotals(){
  const { tokens, totalBTC } = calc();
  totalBtcDisplay.value = tokens ? round8(totalBTC) : "—";
}

/* ✅ Disable PAY buttons until form is valid */
function validateOrderInputs(){
  const { tokens } = calc();
  const ordAddr = (ordinalsInput.value || "").trim();
  // simple sanity check (we can tighten later)
  return tokens > 0 && ordAddr.length > 10;
}
function refreshPayButtonState(){
  const ok = validateOrderInputs();
  payWithUnisatBtn.disabled = !ok;
  openMobileOptionsBtn.disabled = !ok;
}

function looksLikeTxid(txid){
  // Basic BTC txid sanity check: 64 hex chars
  return /^[a-fA-F0-9]{64}$/.test(txid);
}

async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    showToast("Copied.");
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    showToast("Copied.");
  }
}

/** =========================
 *  Sheet logging
 *  ========================= */
async function logToSheet(payload){
  const res = await fetch(SHEETS_WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  const data = await res.json().catch(()=> ({}));
  if(!res.ok || data.ok === false){
    throw new Error(data.error || "Sheet logging failed.");
  }
  return data;
}

/** =========================
 *  UI refs
 *  ========================= */
const connectBtn = document.getElementById("connectBtn");
const buyBtn = document.getElementById("buyBtn");

const buyModalBackdrop = document.getElementById("buyModalBackdrop");
const closeBuyModalBtn = document.getElementById("closeBuyModalBtn");

const tokensInput = document.getElementById("tokensInput");
const ordinalsInput = document.getElementById("ordinalsInput");
const buyerWalletInput = document.getElementById("buyerWalletInput");
const totalBtcDisplay = document.getElementById("totalBtcDisplay");

const payWithUnisatBtn = document.getElementById("payWithUnisatBtn");
const openMobileOptionsBtn = document.getElementById("openMobileOptionsBtn");

const mobileModalBackdrop = document.getElementById("mobileModalBackdrop");
const closeMobileModalBtn = document.getElementById("closeMobileModalBtn");

const pageUrlCode = document.getElementById("pageUrlCode");
const btcAddrCode = document.getElementById("btcAddrCode");
const btcAmountCode = document.getElementById("btcAmountCode");
const qrImg = document.getElementById("qrImg");
const copyPageUrlBtn = document.getElementById("copyPageUrlBtn");
const txidInput = document.getElementById("txidInput");
const submitPaidBtn = document.getElementById("submitPaidBtn");

/** =========================
 *  Wiring
 *  ========================= */
tokensInput.addEventListener("input", ()=>{
  setTotals();
  refreshPayButtonState();
});
ordinalsInput.addEventListener("input", refreshPayButtonState);

buyBtn.addEventListener("click", ()=>{
  setTotals();
  refreshPayButtonState();
  openModal("buyModal");
});

buyModalBackdrop.addEventListener("click", ()=> closeModal("buyModal"));
closeBuyModalBtn.addEventListener("click", ()=> closeModal("buyModal"));

mobileModalBackdrop.addEventListener("click", ()=> closeModal("mobileModal"));
closeMobileModalBtn.addEventListener("click", ()=> closeModal("mobileModal"));

/* ✅ Updated CONNECT logic (connect + UI “disconnect”) */
connectBtn.addEventListener("click", async ()=>{
  // If already “connected”, treat click as “disconnect” (UI-only)
  if(connectBtn.dataset.connected === "1"){
    connectedAccount = "";
    setConnectBtnUI();
    showToast("Disconnected (site only).");
    return;
  }

  if(!hasUnisat()){
    if(isMobile()){
      showToast("UniSat not detected on this mobile browser. Use Mobile Options inside BUY.");
    }else{
      showToast("UniSat not detected. Install UniSat extension and refresh.");
    }
    return;
  }

  try{
    const accounts = await window.unisat.requestAccounts();
    connectedAccount = (accounts && accounts[0]) ? accounts[0] : "";

    if(connectedAccount){
      setConnectBtnUI();
      showToast("Wallet connected.");
    }else{
      showToast("Wallet connect cancelled.");
    }

    // Keep UI synced if UniSat supports events
    if(window.unisat.on && !window.__unisatEventsBound){
      window.__unisatEventsBound = true;

      window.unisat.on("accountsChanged", (accounts)=>{
        connectedAccount = (accounts && accounts[0]) ? accounts[0] : "";
        setConnectBtnUI();
      });

      window.unisat.on("disconnect", ()=>{
        connectedAccount = "";
        setConnectBtnUI();
      });
    }

  }catch(err){
    showToast(err?.message || "Wallet connect failed.");
  }
});

/** =========================
 *  UniSat pay flow (desktop / injected env)
 *  ========================= */
payWithUnisatBtn.addEventListener("click", async ()=>{
  const { tokens, totalBTC } = calc();
  const ordAddr = (ordinalsInput.value || "").trim();
  const buyerWallet = (buyerWalletInput.value || "").trim();

  if(!tokens){
    showToast("Enter token quantity.");
    return;
  }
  if(!ordAddr){
    showToast("Enter your Ordinals address.");
    return;
  }

  // Confirm address reminder
  if(!confirm("Double-check you entered a Runes-capable Ordinals address for delivery. Continue?")){
    return;
  }

  // If UniSat missing, route to mobile options (best UX)
  if(!hasUnisat()){
    openMobileOptions(); // shows options without scary error
    return;
  }

  try{
    // ensure connected
    const accounts = await window.unisat.requestAccounts();
    const payer = accounts?.[0] || "";
    if(payer){
      connectedAccount = payer;
      setConnectBtnUI();
    }

    const amountStr = round8(totalBTC);
    const txid = await window.unisat.sendBitcoin(BTC_RECEIVE_ADDRESS, amountStr);

    // Log PAID (txid captured)
    await logToSheet({
      Timestamp: new Date().toISOString(),
      Status: "PAID",
      Tokens: String(tokens),
      PricePerTokenBTC: String(PRICE_PER_TOKEN_BTC),
      TotalBTC: amountStr,
      OrdinalsAddress: ordAddr,
      BuyerWallet: payer || buyerWallet || "",
      TxId: txid || "",
      Notes: "Paid via UniSat",
      UserAgent: navigator.userAgent,
      PageURL: window.location.href,
      Completed: "N"
    });

    closeModal("buyModal");
    showToast("Thank you. Delivery within 24 hours (batched).");

  }catch(err){
    showToast(err?.message || "Payment failed or cancelled.");
  }
});

/** =========================
 *  Mobile options
 *  ========================= */
openMobileOptionsBtn.addEventListener("click", openMobileOptions);

function openMobileOptions(){
  const { tokens, totalBTC } = calc();
  const ordAddr = (ordinalsInput.value || "").trim();

  if(!tokens){
    showToast("Enter token quantity first.");
    return;
  }
  if(!ordAddr){
    showToast("Enter your Ordinals address first.");
    return;
  }

  pageUrlCode.textContent = window.location.href;
  btcAddrCode.textContent = BTC_RECEIVE_ADDRESS;
  btcAmountCode.textContent = round8(totalBTC);

  // Build BIP21
  const bip21 = `bitcoin:${BTC_RECEIVE_ADDRESS}?amount=${round8(totalBTC)}`;

  // QR image via public QR generator (fast + reliable).
  const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=" + encodeURIComponent(bip21);
  qrImg.src = qrUrl;

  openModal("mobileModal");
}

copyPageUrlBtn.addEventListener("click", ()=> copyToClipboard(window.location.href));

/** =========================
 *  Manual BTC (QR) submit TXID — logs as PAID only when TXID exists
 *  ========================= */
submitPaidBtn.addEventListener("click", async ()=>{
  const { tokens, totalBTC } = calc();
  const ordAddr = (ordinalsInput.value || "").trim();
  const buyerWallet = (buyerWalletInput.value || "").trim();
  const txid = (txidInput.value || "").trim();

  if(!looksLikeTxid(txid)){
    showToast("TXID must be 64 hex characters. Paste the full TXID.");
    return;
  }

  // Final confirmation
  if(!confirm("Confirm: you sent the exact amount and this TXID is correct. Submit receipt?")){
    return;
  }

  try{
    await logToSheet({
      Timestamp: new Date().toISOString(),
      Status: "PAID",
      Tokens: String(tokens),
      PricePerTokenBTC: String(PRICE_PER_TOKEN_BTC),
      TotalBTC: round8(totalBTC),
      OrdinalsAddress: ordAddr,
      BuyerWallet: buyerWallet || "",
      TxId: txid,
      Notes: "Paid via Mobile QR (TXID provided by buyer)",
      UserAgent: navigator.userAgent,
      PageURL: window.location.href,
      Completed: "N"
    });

    closeModal("mobileModal");
    closeModal("buyModal");
    txidInput.value = "";
    showToast("Receipt recorded. Delivery within 24 hours (batched).");

  }catch(err){
    showToast(err?.message || "Could not record receipt. Try again.");
  }
});

/* ✅ init */
setConnectBtnUI();
refreshPayButtonState();
</script>

</body>
</html>



